<!DOCTYPE html>
<html>

<head>
    <title>Playlist</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <%- include('./templates/headLinks'); %>

    <script type="text/javascript">
        // find template and compile it
        var templateSource = document.getElementById('results-template').innerHTML,
            template = Handlebars.compile(templateSource),
            resultsPlaceholder = document.getElementById('results'),
            playingCssClass = 'playing',
            audioObject = null;

        var fetchTracks = function (albumId, callback) {
            $.ajax({
                url: 'https://api.spotify.com/v1/albums/' + albumId,
                success: function (response) {
                    callback(response);
                }
            });
        };

        var searchAlbums = function (query) {
            $.ajax({
                url: 'https://api.spotify.com/v1/search',
                data: {
                    q: query,
                    type: 'track'
                },
                success: function (response) {
                    resultsPlaceholder.innerHTML = template(response);
                }
            });
        };

        results.addEventListener('click', function (e) {
            var target = e.target;
            if (target !== null && target.classList.contains('cover')) {
                if (target.classList.contains(playingCssClass)) {
                    audioObject.pause();
                } else {
                    if (audioObject) {
                        audioObject.pause();
                    }
                    fetchTracks(target.getAttribute('data-album-id'), function (data) {
                        audioObject = new Audio(data.tracks.items[0].preview_url);
                        
        //data.tracks.items[0].artists[0].name                        
                        
                        audioObject.play();
                        target.classList.add(playingCssClass);
                        audioObject.addEventListener('ended', function () {
                            target.classList.remove(playingCssClass);
                        });
                        audioObject.addEventListener('pause', function () {
                            target.classList.remove(playingCssClass);
                        });
                    });
                }
            }
        });

        document.getElementById('search-form').addEventListener('submit', function (e) {
            e.preventDefault();
            searchAlbums(document.getElementById('query').value);
        }, false);
    </script>

</head>

<body>

<%- include('./templates/header'); %>


<h1></h1>

<div class="center"></div>
<div class="row" style="font-size: 200%; margin-top: 90px;">
    <% if(!spotauth){%>
        <div class="col-sm-4" align="center">
            <div class="list-group">
                <a id="spotbutt" href = "#" class="list-group-item active">
                    Spotify
                </a>
                <div class="jumbotron">
                    <a href="/spotify" class="btn btn-success"><span class="fa fa-spotify" style="padding: 15px; font-size: 150%;"> Spotify</span></a>
                </div>
            </div>
        </div>
    <%} else {%> 
        <div class="col-sm-4" align="center">
            <div class="list-group">
                <a id="spotbutt" href = "#" class="list-group-item active">
                    Spotify
                </a>
            <div class = "panel-group" id = "spotify-playlists"></div>
            </div>
        </div>
    <%}%>

    <!-- Reserved section for the builder, coming up next :) -->
    <div class="col-sm-4" align="center">
        <a href="#" class="list-group-item active">
            Builder
        </a>
        <a href="#" class="list-group-item">I love
        </a>
        <a href="#" class="list-group-item">Music and stuff
        </a>
    </div>

    <!--googles not authorized, don't show the playlists.-->
    <% if(!authorized){ %>
    <div class="col-md-4" align="center">
        <div class="list-group">
            <a id="youbutt" href="#" class="list-group-item active">
                Youtube
            </a>
            <div class="jumbotron">
                <a href="/oauth" class="btn btn-danger"><span class="fa fa-youtube" style="padding: 15px; font-size: 200%;"> YouTube</span></a>
            </div>
        </div>
    </div>
    <% }else {%>
    <div class="col-md-4" align="center">
        <div class="list-group">
            <a id="youbutt" href="#" class="list-group-item active">
                Youtube
            </a>
            <div class="panel-group" id = "youtube-playlists"></div>
        </div>
    </div>
    <%}%>
</div>


<script id="results-template" type="text/x-handlebars-template">
    {{#each tracks.items}}
    <div >{{id}} -         
        <br /> {{name}} <br/></div>
    <div style="border:1px solid red; background-image:url({{album.images.2.url}})" data-album-id="{{id}}" class="cover"></div>
    <div style="border:1px solid green; "> Artist name = {{artists.0.name}} </div>
    <div style="border:1px solid green; "> Album Type = {{album.album_type}} </div>
    <div style="border:1px solid green; "> Album name = {{album.name}} </div>
    
    {{/each}}
</script>

<!-- include the ajax calls to grab the playlists! -->

<div id="demo-toast-example" class="mdl-js-snackbar mdl-snackbar">
    <div class="mdl-snackbar__text"></div>
    <button class="mdl-snackbar__action" type="button"></button>
</div>

<script>
    r(function(){
        var snackbarContainer = document.querySelector('#demo-toast-example');
        var data = { message: 'Welcome'};
        snackbarContainer.MaterialSnackbar.showSnackbar(data);
    });
    function r(f){ /in/.test(document.readyState)?setTimeout('r('+f+')',9):f()}
</script>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script
  src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous"></script>
  
<% include displayplaylists%>
<%- include('./templates/footer'); %>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<%- include('./templates/bodyScript'); %>

</body>
</html>